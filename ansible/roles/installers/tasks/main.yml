---
# ansible/roles/installers/tasks/main.yml
# Downloads all installer binaries for air-gapped use (multi-platform support)

- name: Detect platform and architecture
  set_fact:
    platforms:
      - os: "linux"
        arches: ["amd64", "arm64"]
      - os: "darwin"
        arches: ["arm64"]  # macOS arm64 only
      - os: "windows"
        arches: ["amd64"]

- name: Create base installers directory
  file:
    path: "{{ installers_dir }}"
    state: directory
    mode: '0755'

- name: Create per-OS installers subdirectories
  file:
    path: "{{ installers_dir }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - linux
    - macos
    - windows

# ====================
# k3s Downloads
# ====================
- name: Download k3s binary (Linux amd64)
  get_url:
    url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s"
    dest: "{{ installers_dir }}/linux/k3s"
    checksum: "sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt"
    mode: '0755'
    force: no

- name: Download k3s binary (Linux arm64)
  get_url:
    url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s-arm64"
    dest: "{{ installers_dir }}/linux/k3s-arm64"
    checksum: "sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-arm64.txt"
    mode: '0755'
    force: no

# ====================
# Helm Downloads
# ====================
- name: Download helm (Linux amd64)
  get_url:
    url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
    dest: "{{ installers_dir }}/linux/helm-linux-amd64.tar.gz"
    checksum: "sha256:https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz.sha256sum"
    mode: '0644'
    force: no

- name: Download helm (Linux arm64)
  get_url:
    url: "https://get.helm.sh/helm-{{ helm_version }}-linux-arm64.tar.gz"
    dest: "{{ installers_dir }}/linux/helm-linux-arm64.tar.gz"
    checksum: "sha256:https://get.helm.sh/helm-{{ helm_version }}-linux-arm64.tar.gz.sha256sum"
    mode: '0644'
    force: no

- name: Download helm (macOS arm64)
  get_url:
    url: "https://get.helm.sh/helm-{{ helm_version }}-darwin-arm64.tar.gz"
    dest: "{{ installers_dir }}/macos/helm-darwin-arm64.tar.gz"
    checksum: "sha256:https://get.helm.sh/helm-{{ helm_version }}-darwin-arm64.tar.gz.sha256sum"
    mode: '0644'
    force: no

- name: Download helm (Windows amd64)
  get_url:
    url: "https://get.helm.sh/helm-{{ helm_version }}-windows-amd64.zip"
    dest: "{{ installers_dir }}/windows/helm-windows-amd64.zip"
    checksum: "sha256:https://get.helm.sh/helm-{{ helm_version }}-windows-amd64.zip.sha256sum"
    mode: '0644'
    force: no

# ====================
# k9s Downloads
# ====================
- name: Download k9s (Linux amd64)
  get_url:
    url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Linux_amd64.tar.gz"
    dest: "{{ installers_dir }}/linux/k9s_Linux_amd64.tar.gz"
    checksum: "sha256:https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/checksums.sha256"
    mode: '0644'
    force: no

- name: Download k9s (Linux arm64)
  get_url:
    url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Linux_arm64.tar.gz"
    dest: "{{ installers_dir }}/linux/k9s_Linux_arm64.tar.gz"
    checksum: "sha256:https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/checksums.sha256"
    mode: '0644'
    force: no

- name: Download k9s (macOS arm64)
  get_url:
    url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Darwin_arm64.tar.gz"
    dest: "{{ installers_dir }}/macos/k9s_Darwin_arm64.tar.gz"
    checksum: "sha256:https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/checksums.sha256"
    mode: '0644'
    force: no

- name: Download k9s (Windows amd64)
  get_url:
    url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Windows_amd64.zip"
    dest: "{{ installers_dir }}/windows/k9s_Windows_amd64.zip"
    checksum: "sha256:https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/checksums.sha256"
    mode: '0644'
    force: no

# ====================
# mkcert Downloads
# ====================
- name: Download mkcert (Linux amd64)
  get_url:
    url: "https://github.com/FiloSottile/mkcert/releases/download/{{ mkcert_version }}/mkcert-{{ mkcert_version }}-linux-amd64"
    dest: "{{ installers_dir }}/linux/mkcert-linux-amd64"
    mode: '0755'
    force: no

- name: Download mkcert (Linux arm64)
  get_url:
    url: "https://github.com/FiloSottile/mkcert/releases/download/{{ mkcert_version }}/mkcert-{{ mkcert_version }}-linux-arm64"
    dest: "{{ installers_dir }}/linux/mkcert-linux-arm64"
    mode: '0755'
    force: no

- name: Download mkcert (macOS arm64)
  get_url:
    url: "https://github.com/FiloSottile/mkcert/releases/download/{{ mkcert_version }}/mkcert-{{ mkcert_version }}-darwin-arm64"
    dest: "{{ installers_dir }}/macos/mkcert-darwin-arm64"
    mode: '0755'
    force: no

- name: Download mkcert (Windows amd64)
  get_url:
    url: "https://github.com/FiloSottile/mkcert/releases/download/{{ mkcert_version }}/mkcert-{{ mkcert_version }}-windows-amd64.exe"
    dest: "{{ installers_dir }}/windows/mkcert-windows-amd64.exe"
    mode: '0755'
    force: no

# ====================
# zstd Downloads
# ====================
# ====================

# ====================
# Hauler Downloads
# ====================
- name: Download hauler (Linux amd64)
  get_url:
    url: "https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_linux_amd64.tar.gz"
    dest: "{{ installers_dir }}/linux/hauler_linux_amd64.tar.gz"
    checksum: "sha256:https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_checksums.txt"
    mode: '0644'
    force: no

- name: Download hauler (Linux arm64)
  get_url:
    url: "https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_linux_arm64.tar.gz"
    dest: "{{ installers_dir }}/linux/hauler_linux_arm64.tar.gz"
    checksum: "sha256:https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_checksums.txt"
    mode: '0644'
    force: no

- name: Download hauler (macOS arm64)
  get_url:
    url: "https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_darwin_arm64.tar.gz"
    dest: "{{ installers_dir }}/macos/hauler_darwin_arm64.tar.gz"
    checksum: "sha256:https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_checksums.txt"
    mode: '0644'
    force: no

- name: Download hauler (Windows amd64)
  get_url:
    url: "https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_windows_amd64.tar.gz"
    dest: "{{ installers_dir }}/windows/hauler_windows_amd64.tar.gz"
    checksum: "sha256:https://github.com/hauler-dev/hauler/releases/download/{{ hauler_version }}/hauler_{{ hauler_version | regex_replace('^v', '') }}_checksums.txt"
    mode: '0644'
    force: no

# ====================
# Rancher Desktop Downloads
# ====================
- name: Download Rancher Desktop (macOS arm64)
  get_url:
    url: "https://github.com/rancher-sandbox/rancher-desktop/releases/download/{{ rancher_desktop_version }}/Rancher.Desktop-{{ rancher_desktop_version | regex_replace('^v', '') }}.aarch64.dmg"
    dest: "{{ installers_dir }}/macos/Rancher.Desktop.dmg"
    checksum: "sha512:https://github.com/rancher-sandbox/rancher-desktop/releases/download/{{ rancher_desktop_version }}/Rancher.Desktop-{{ rancher_desktop_version | regex_replace('^v', '') }}.aarch64.dmg.sha512sum"
    mode: '0644'
    force: no

- name: Download Rancher Desktop (Windows amd64)
  get_url:
    url: "https://github.com/rancher-sandbox/rancher-desktop/releases/download/{{ rancher_desktop_version }}/Rancher.Desktop.Setup.{{ rancher_desktop_version | regex_replace('^v', '') }}.msi"
    dest: "{{ installers_dir }}/windows/Rancher.Desktop.Setup.msi"
    checksum: "sha512:https://github.com/rancher-sandbox/rancher-desktop/releases/download/{{ rancher_desktop_version }}/Rancher.Desktop.Setup.{{ rancher_desktop_version | regex_replace('^v', '') }}.msi.sha512sum"
    mode: '0644'
    force: no

# ====================
# Generate manifest
# ====================
- name: Create installers index.json
  copy:
    content: |
      {
        "generated": "{{ ansible_date_time.iso8601 }}",
        "notes": "kubectl is bundled with k3s. hauler handles tarball extraction.",
        "versions": {
          "k3s": "{{ k3s_version }}",
          "helm": "{{ helm_version }}",
          "k9s": "{{ k9s_version }}",
          "mkcert": "{{ mkcert_version }}",
          "rancher_desktop": "{{ rancher_desktop_version }}",
          "hauler": "{{ hauler_version }}"
        },
        "platforms": {
          "linux": {
            "architectures": ["amd64", "arm64"],
            "files": [
              "k3s", "k3s-arm64",
              "helm-linux-amd64.tar.gz", "helm-linux-arm64.tar.gz",
              "k9s_Linux_amd64.tar.gz", "k9s_Linux_arm64.tar.gz",
              "mkcert-linux-amd64", "mkcert-linux-arm64",
              "hauler_linux_amd64.tar.gz", "hauler_linux_arm64.tar.gz"
            ]
          },
          "macos": {
            "architectures": ["arm64"],
            "files": [
              "helm-darwin-arm64.tar.gz",
              "k9s_Darwin_arm64.tar.gz",
              "mkcert-darwin-arm64",
              "Rancher.Desktop.dmg",
              "hauler_darwin_arm64.tar.gz"
            ]
          },
          "windows": {
            "architectures": ["amd64"],
            "files": [
              "helm-windows-amd64.zip",
              "k9s_Windows_amd64.zip",
              "mkcert-windows-amd64.exe",
              "Rancher.Desktop.Setup.msi",
              "hauler_windows_amd64.tar.gz"
            ]
          }
        }
      }
    dest: "{{ installers_dir }}/index.json"
    mode: '0644'
