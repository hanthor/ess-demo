---
# ansible/roles/packaging/tasks/main.yml
# Create per-OS air-gapped packages with installers, hauler store, setup scripts

- name: Verify required artifacts exist
  assert:
    that:
      - installers_dir is defined
      - hauler_store_path is defined
      - lookup('file', hauler_store_path + '/index.json') is defined
    fail_msg: "Missing required artifacts. Run 'just capture-images' first."

- name: Create packaging temporary directory
  file:
    path: "{{ packaging_temp_dir }}"
    state: directory
    mode: '0755'

# ====================
# Linux Package
# ====================
- name: Create Linux package structure
  file:
    path: "{{ packaging_temp_dir }}/linux-airgap"
    state: directory
    mode: '0755'

- name: Copy Linux installers to package
  shell: |
    mkdir -p {{ packaging_temp_dir }}/linux-airgap/installers
    cp -r {{ installers_dir }}/linux/* {{ packaging_temp_dir }}/linux-airgap/installers/
    cp {{ installers_dir }}/index.json {{ packaging_temp_dir }}/linux-airgap/installers/

- name: Copy hauler store to Linux package
  shell: |
    cp -r {{ hauler_store_path }} {{ packaging_temp_dir }}/linux-airgap/

- name: Generate Linux setup script
  copy:
    content: |
      #!/bin/bash
      # ESS Demo Air-gapped Setup - Linux
      set -e
      
      SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
      INSTALLERS_DIR="$SCRIPT_DIR/installers"
      HAULER_STORE="$SCRIPT_DIR/hauler-store"
      
      echo "üì¶ ESS Demo Air-gapped Setup - Linux"
      echo "========================================"
      
      # Detect architecture
      ARCH=$(uname -m)
      case "$ARCH" in
        x86_64) ARCH="amd64" ;;
        aarch64) ARCH="arm64" ;;
        *) echo "‚ùå Unsupported architecture: $ARCH"; exit 1 ;;
      esac
      
      echo "üîç Detected architecture: $ARCH"
      
      # Install k3s
      echo "üì• Installing k3s..."
      sudo install -m 755 "$INSTALLERS_DIR/k3s${ARCH:+-$ARCH}" /usr/local/bin/k3s
      sudo /usr/local/bin/k3s server --disable traefik &
      K3S_PID=$!
      
      # Wait for k3s to be ready
      echo "‚è≥ Waiting for k3s to start..."
      for i in {1..60}; do
        if sudo k3s kubectl get nodes 2>/dev/null | grep -q "Ready"; then
          echo "‚úÖ k3s is ready"
          break
        fi
        sleep 1
      done
      
      # Extract and prepare hauler
      echo "üì¶ Extracting hauler..."
      mkdir -p /tmp/hauler-extract
      tar -xz -C /tmp/hauler-extract -f "$INSTALLERS_DIR/hauler_linux_${ARCH}.tar.gz"
      sudo install -m 755 /tmp/hauler-extract/hauler /usr/local/bin/
      
      # Load hauler store
      echo "üìÇ Loading images from hauler store..."
      hauler store load --store "$HAULER_STORE" -k
      
      # Extract and install helm
      echo "üéØ Installing helm..."
      mkdir -p /tmp/helm-extract
      tar -xz -C /tmp/helm-extract -f "$INSTALLERS_DIR/helm-linux-${ARCH}.tar.gz"
      sudo install -m 755 /tmp/helm-extract/linux-${ARCH}/helm /usr/local/bin/
      
      # Deploy ESS
      echo "üöÄ Deploying ESS with Helm..."
      helm repo add matrix-stack https://ess.element.io/kubernetes/matrix-stack/
      helm install matrix-stack matrix-stack/matrix-stack \
        --values "$SCRIPT_DIR/demo-values.yaml" \
        --wait \
        --timeout 10m
      
      echo "‚úÖ ESS deployment complete!"
      echo "üìã Check status with: sudo k3s kubectl get pods -A"
    dest: "{{ packaging_temp_dir }}/linux-airgap/setup.sh"
    mode: '0755'

- name: Generate Linux package tarball
  shell: |
    cd {{ packaging_temp_dir }}
    tar -czf linux-airgap.tar.gz linux-airgap/
    mv linux-airgap.tar.gz {{ packages_dir }}/
    echo "‚úÖ Created {{ packages_dir }}/linux-airgap.tar.gz"

# ====================
# macOS Package
# ====================
- name: Create macOS package structure
  file:
    path: "{{ packaging_temp_dir }}/macos-airgap"
    state: directory
    mode: '0755'

- name: Copy macOS installers to package
  shell: |
    mkdir -p {{ packaging_temp_dir }}/macos-airgap/installers
    cp -r {{ installers_dir }}/macos/* {{ packaging_temp_dir }}/macos-airgap/installers/
    cp {{ installers_dir }}/index.json {{ packaging_temp_dir }}/macos-airgap/installers/

- name: Copy hauler store to macOS package
  shell: |
    cp -r {{ hauler_store_path }} {{ packaging_temp_dir }}/macos-airgap/

- name: Generate macOS setup script
  copy:
    content: |
      #!/bin/bash
      # ESS Demo Air-gapped Setup - macOS
      set -e
      
      SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
      INSTALLERS_DIR="$SCRIPT_DIR/installers"
      HAULER_STORE="$SCRIPT_DIR/hauler-store"
      
      echo "üì¶ ESS Demo Air-gapped Setup - macOS"
      echo "========================================"
      echo ""
      echo "‚ö†Ô∏è  Prerequisites:"
      echo "   - Rancher Desktop or Docker Desktop installed"
      echo "   - brew installed"
      echo ""
      
      # Verify Rancher Desktop/Docker
      if ! (command -v rancher-desktop >/dev/null 2>&1 || command -v docker >/dev/null 2>&1); then
        echo "‚ùå Rancher Desktop or Docker Desktop required. Install with:"
        echo "   brew install rancher-desktop"
        exit 1
      fi
      
      echo "üîç Detected arm64 macOS"
      
      # Extract and prepare hauler
      echo "üì¶ Extracting hauler..."
      mkdir -p /tmp/hauler-extract
      tar -xz -C /tmp/hauler-extract -f "$INSTALLERS_DIR/hauler_darwin_arm64.tar.gz"
      sudo install -m 755 /tmp/hauler-extract/hauler /usr/local/bin/
      
      # Load hauler store into container runtime
      echo "üìÇ Loading images into container runtime..."
      hauler store load --store "$HAULER_STORE"
      
      # Extract and install helm
      echo "üéØ Installing helm..."
      mkdir -p /tmp/helm-extract
      tar -xz -C /tmp/helm-extract -f "$INSTALLERS_DIR/helm-darwin-arm64.tar.gz"
      sudo install -m 755 /tmp/helm-extract/darwin-arm64/helm /usr/local/bin/
      
      echo "‚úÖ macOS setup complete!"
      echo ""
      echo "üìã Next steps:"
      echo "   1. Start Rancher Desktop: open -a Rancher\ Desktop"
      echo "   2. Run: helm install matrix-stack matrix-stack/matrix-stack --values demo-values.yaml"
    dest: "{{ packaging_temp_dir }}/macos-airgap/setup.sh"
    mode: '0755'

- name: Generate macOS package tarball
  shell: |
    cd {{ packaging_temp_dir }}
    tar -czf macos-airgap.tar.gz macos-airgap/
    mv macos-airgap.tar.gz {{ packages_dir }}/
    echo "‚úÖ Created {{ packages_dir }}/macos-airgap.tar.gz"

# ====================
# Windows Package
# ====================
- name: Create Windows package structure
  file:
    path: "{{ packaging_temp_dir }}/windows-airgap"
    state: directory
    mode: '0755'

- name: Copy Windows installers to package
  shell: |
    mkdir -p {{ packaging_temp_dir }}/windows-airgap/installers
    cp -r {{ installers_dir }}/windows/* {{ packaging_temp_dir }}/windows-airgap/installers/
    cp {{ installers_dir }}/index.json {{ packaging_temp_dir }}/windows-airgap/installers/

- name: Copy hauler store to Windows package
  shell: |
    cp -r {{ hauler_store_path }} {{ packaging_temp_dir }}/windows-airgap/

- name: Generate Windows setup script (PowerShell)
  copy:
    content: |
      # ESS Demo Air-gapped Setup - Windows
      
      $ErrorActionPreference = "Stop"
      
      $ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
      $InstallersDir = Join-Path $ScriptDir "installers"
      $HaulerStore = Join-Path $ScriptDir "hauler-store"
      
      Write-Host "üì¶ ESS Demo Air-gapped Setup - Windows" -ForegroundColor Green
      Write-Host "========================================"
      Write-Host ""
      Write-Host "‚ö†Ô∏è  Prerequisites:" -ForegroundColor Yellow
      Write-Host "   - Rancher Desktop or Docker Desktop installed"
      Write-Host "   - PowerShell 7+ or Windows PowerShell with Admin privileges"
      Write-Host ""
      
      # Check for container runtime
      try {
        $null = docker --version
      } catch {
        Write-Host "‚ùå Docker or Rancher Desktop required. Install with:" -ForegroundColor Red
        Write-Host "   https://rancherdesktop.io/"
        exit 1
      }
      
      # Extract hauler
      Write-Host "üì¶ Extracting hauler..." -ForegroundColor Cyan
      $HaulerZip = Join-Path $InstallersDir "hauler_windows_amd64.tar.gz"
      # Note: May need 7-Zip or Windows tar support (Win10+)
      
      Write-Host "üìÇ Loading images from hauler store..." -ForegroundColor Cyan
      & hauler store load --store "$HaulerStore"
      
      # Extract helm
      Write-Host "üéØ Installing helm..." -ForegroundColor Cyan
      $HelmZip = Join-Path $InstallersDir "helm-windows-amd64.zip"
      Expand-Archive -Path $HelmZip -DestinationPath "$env:PROGRAMFILES\helm" -Force
      
      Write-Host "‚úÖ Windows setup complete!" -ForegroundColor Green
      Write-Host ""
      Write-Host "üìã Next steps:" -ForegroundColor Yellow
      Write-Host "   1. Start Rancher Desktop"
      Write-Host "   2. Run: helm install matrix-stack matrix-stack/matrix-stack --values demo-values.yaml"
    dest: "{{ packaging_temp_dir }}/windows-airgap/setup.ps1"
    mode: '0755'

- name: Generate Windows package ZIP
  shell: |
    cd {{ packaging_temp_dir }}
    zip -r windows-airgap.zip windows-airgap/
    mv windows-airgap.zip {{ packages_dir }}/
    echo "‚úÖ Created {{ packages_dir }}/windows-airgap.zip"

# ====================
# Generate Package Manifest
# ====================
- name: Generate package manifest
  copy:
    content: |
      {
        "generated": "{{ ansible_date_time.iso8601 }}",
        "packages": {
          "linux": {
            "filename": "linux-airgap.tar.gz",
            "architectures": ["amd64", "arm64"],
            "contents": [
              "installers/ (k3s, helm, k9s, mkcert, hauler, Rancher Desktop)",
              "hauler-store/ (all cluster container images)",
              "setup.sh (automated setup script)",
              "index.json (manifest)"
            ],
            "instructions": [
              "1. tar -xzf linux-airgap.tar.gz",
              "2. cd linux-airgap",
              "3. ./setup.sh"
            ]
          },
          "macos": {
            "filename": "macos-airgap.tar.gz",
            "architectures": ["arm64"],
            "contents": [
              "installers/ (helm, k9s, mkcert, hauler, Rancher Desktop)",
              "hauler-store/ (all cluster container images)",
              "setup.sh (setup guide script)",
              "index.json (manifest)"
            ],
            "instructions": [
              "1. tar -xzf macos-airgap.tar.gz",
              "2. cd macos-airgap",
              "3. bash setup.sh"
            ]
          },
          "windows": {
            "filename": "windows-airgap.zip",
            "architectures": ["amd64"],
            "contents": [
              "installers/ (helm, k9s, mkcert, hauler, Rancher Desktop)",
              "hauler-store/ (all cluster container images)",
              "setup.ps1 (setup guide script)",
              "index.json (manifest)"
            ],
            "instructions": [
              "1. Expand-Archive windows-airgap.zip",
              "2. cd windows-airgap",
              "3. .\\setup.ps1"
            ]
          }
        },
        "notes": {
          "airgap": "All packages include complete container images. No internet required after extraction.",
          "sizes": "See individual package files for exact sizes.",
          "versions": {
            "k3s": "{{ k3s_version }}",
            "helm": "{{ helm_version }}",
            "k9s": "{{ k9s_version }}",
            "mkcert": "{{ mkcert_version }}",
            "hauler": "{{ hauler_version }}"
          }
        }
      }
    dest: "{{ packages_dir }}/MANIFEST.json"
    mode: '0644'

- name: Generate package README
  copy:
    content: |
      # ESS Demo Air-gapped Packages
      
      Complete, ready-to-deploy air-gapped packages for ESS deployment.
      
      ## Contents
      
      - `linux-airgap.tar.gz` - Linux (amd64/arm64) complete package
      - `macos-airgap.tar.gz` - macOS (arm64) complete package  
      - `windows-airgap.zip` - Windows (amd64) complete package
      - `MANIFEST.json` - Package metadata and contents
      
      ## What's Inside
      
      Each package contains:
      1. **installers/** - All necessary binaries (k3s, helm, k9s, mkcert, hauler)
      2. **hauler-store/** - Complete OCI image store with all cluster images
      3. **setup script** - Automated setup (Linux/macOS) or guide (Windows)
      4. **index.json** - Binary manifest
      
      ## Quick Start
      
      ### Linux
      ```bash
      tar -xzf linux-airgap.tar.gz
      cd linux-airgap
      ./setup.sh
      ```
      
      ### macOS
      ```bash
      tar -xzf macos-airgap.tar.gz
      cd macos-airgap
      bash setup.sh
      ```
      
      ### Windows
      ```powershell
      Expand-Archive -Path windows-airgap.zip -DestinationPath .
      cd windows-airgap
      .\\setup.ps1
      ```
      
      ## Features
      
      - **Complete Air-gapped** - No internet required after extraction
      - **Multi-architecture** - Linux amd64/arm64, macOS arm64, Windows amd64
      - **Single Runtime** - k3s for Linux, container runtime (Rancher Desktop/Docker) for macOS/Windows
      - **Automatic Setup** - Scripts handle installation and deployment
      - **Verified Checksums** - All binaries integrity-checked
      
      ## Troubleshooting
      
      See individual setup scripts for platform-specific troubleshooting.
      
      Generated: {{ ansible_date_time.iso8601 }}
    dest: "{{ packages_dir }}/README.md"
    mode: '0644'

- name: Display packaging summary
  debug:
    msg: |
      ‚úÖ Air-gapped Packages Created!
      
      Location: {{ packages_dir }}/
      
      Packages:
        - linux-airgap.tar.gz (Linux amd64/arm64)
        - macos-airgap.tar.gz (macOS arm64)
        - windows-airgap.zip (Windows amd64)
      
      Documentation:
        - MANIFEST.json (package metadata)
        - README.md (quick start guide)
      
      Each package is self-contained and requires NO internet for deployment.
