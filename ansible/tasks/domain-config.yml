---
# Domain Configuration Tasks
# Prompts for and configures domain name

- name: Prompt for domain name if not provided
  pause:
    prompt: "Enter the base domain name for your ESS deployment (e.g., ess.localhost)"
  register: domain_prompt
  when: domain_name == ''

- name: Set domain name from prompt
  set_fact:
    domain_name: "{{ domain_prompt.user_input }}"
  when: domain_name == ''

- name: Validate domain name
  fail:
    msg: "Domain name cannot be empty"
  when: domain_name == ''

- name: Create demo-values directory
  file:
    path: "{{ demo_values_dir }}"
    state: directory
    mode: '0755'

- name: Generate hostnames configuration
  copy:
    content: |
      # ESS Demo Hostnames Configuration
      # Auto-generated by Ansible playbook

      wellKnown:
        server: "matrix.{{ domain_name }}"
        client:
          m.homeserver:
            base_url: "https://matrix.{{ domain_name }}"

      global:
        hosts:
          element:
            external: "chat.{{ domain_name }}"
          admin:
            external: "admin.{{ domain_name }}"
          synapse:
            external: "matrix.{{ domain_name }}"
          mas:
            external: "auth.{{ domain_name }}"
    dest: "{{ demo_values_dir }}/hostnames.yaml"
    mode: '0644'

- name: Generate TLS configuration
  copy:
    content: |
      # TLS Configuration for ESS Demo
      # Auto-generated by Ansible playbook

      ingress-nginx:
        controller:
          extraArgs:
            default-ssl-certificate: "{{ namespace }}/ess-tls-secret"

      global:
        tls:
          mode: certManager
    dest: "{{ demo_values_dir }}/tls.yaml"
    mode: '0644'

- name: Display domain configuration
  debug:
    msg:
      - "Domain configured: {{ domain_name }}"
      - "Services will be available at:"
      - "  - https://chat.{{ domain_name }}"
      - "  - https://admin.{{ domain_name }}"
      - "  - https://matrix.{{ domain_name }}"
      - "  - https://auth.{{ domain_name }}"
